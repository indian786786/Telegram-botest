<script>
let questions = [];
let index = 0;
let answered = false;

async function start() {
  const topic = document.getElementById("topic").value.trim();
  document.getElementById("quiz").innerHTML = "Loading questions...";
  document.getElementById("explanation").classList.add("hidden");

  try {
    const res = await fetch("https://canvas-ai.saififiroza786.workers.dev", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ topic })
    });

    if (!res.ok) throw new Error("Fetch failed");

    questions = await res.json();

    if (!Array.isArray(questions) || questions.length === 0) {
      throw new Error("Invalid question format");
    }

    index = 0;
    showQuestion();

  } catch (e) {
    console.error(e);
    document.getElementById("quiz").innerHTML =
      "❌ Failed to load questions. Try a clear SSC topic.";
  }
}

function showQuestion() {
  answered = false;
  const quiz = document.getElementById("quiz");
  const exp = document.getElementById("explanation");
  exp.classList.add("hidden");

  if (index >= questions.length) {
    quiz.innerHTML = "✅ Quiz completed";
    return;
  }

  const q = questions[index];
  quiz.innerHTML = `<h3>Q${index + 1}. ${q.question}</h3>`;

  q.options.forEach((opt, i) => {
    const div = document.createElement("div");
    div.className = "option";
    div.innerText = opt;
    div.onclick = () => checkAnswer(div, i);
    quiz.appendChild(div);
  });
}

function checkAnswer(div, i) {
  if (answered) return;
  answered = true;

  const q = questions[index];
  const options = document.querySelectorAll(".option");

  options.forEach(o => o.onclick = null);

  if (i === q.answer) {
    div.classList.add("correct");
  } else {
    div.classList.add("wrong");
    options[q.answer].classList.add("correct");
  }

  const exp = document.getElementById("explanation");
  exp.innerHTML = `<b>Explanation:</b> ${q.explanation}`;
  exp.classList.remove("hidden");
}

function nextQuestion() {
  index++;
  showQuestion();
}
</script>
